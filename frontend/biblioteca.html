<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca</title>
  <link rel="stylesheet" href="css/estilos.css">
  <script src="js/sesion.js" defer></script>
  <script src="js/biblioteca.js" defer></script>
  <script src="js/navegacion.js" defer></script>
</head>
<body>

  <!-- Logo flotante -->
  <div class="logo-flotante">
    <a href="index.html" title="Ir al inicio">
      <img src="imagenes/logo2.jpg" alt="Logo del Club" />
    </a>
  </div>

  <!-- Fondo decorativo -->
  <div class="fondo-biblioteca"></div>

  <!-- Botón de cerrar sesión -->
  <div
    <button id="cerrar-sesion" title="Cerrar sesión">🔓</button>
  </div>

  <!-- Saludo personalizado -->
  <h2 id="saludo"></h2>

  <!-- Filtros de búsqueda -->
  <section id="filtros">
    <input type="text" id="buscador" placeholder="🔍 Buscar libro por título..." />
    <select id="filtro-categoria">
      <option value="todos">Todas las categorías</option>
      <option value="Principiante">Principiante</option>
      <option value="Avanzado">Avanzado</option>
      <option value="Profecionales">Profecionales</option>
    </select>
  </section>

  <!-- Sección dinámica de libros -->
  <section id="galeria">
    <h3>📚 Libros disponibles</h3>
    <div id="contenedor-libros" class="categoria-galeria"></div>
  </section>

  <!-- Botón de inicio -->
  <div
    <button id="boton-inicio" title="Ir al inicio">🏠</button>
  </div>

  <style>
    .libro {
      margin-top: 40px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    .form-comentario textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      resize: vertical;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .form-comentario button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .comentario {
      margin-top: 15px;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
  </style>

  <!-- Script principal -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const usuarioId = localStorage.getItem('usuario_id');
      const usuarioNombre = localStorage.getItem('usuarioNombre');
      const contenedor = document.getElementById('contenedor-libros');

      if (!usuarioId || !usuarioNombre || isNaN(parseInt(usuarioId))) {
        alert('⚠️ Debes iniciar sesión para acceder a la biblioteca');
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('saludo').textContent = `👋 Bienvenido, ${usuarioNombre}`;

      document.getElementById('cerrar-sesion')?.addEventListener('click', () => {
        localStorage.removeItem('usuario_id');
        localStorage.removeItem('usuarioNombre');
        alert('Sesión cerrada correctamente');
        window.location.href = 'login.html';
      });

      try {
        const res = await fetch('http://localhost:3000/api/libros');
        const libros = await res.json();

        libros.forEach(libro => {
          const div = document.createElement('div');
          div.className = 'libro';
          div.dataset.libroId = libro.id;
          div.innerHTML = `
            <h4>📘 ${libro.titulo}</h4>
            <p>${libro.descripcion}</p>
            <form class="form-comentario">
              <textarea placeholder="¿Qué opinas de este libro?" required></textarea>
              <button type="submit">Comentar</button>
            </form>
            <div class="lista-comentarios">
              <p class="sin-comentarios" style="color: gray;">Sé el primero en comentar este libro.</p>
            </div>
          `;
          contenedor.appendChild(div);
          prepararComentarios(div, libro.id, usuarioId);
        });
      } catch (error) {
        console.error('Error al cargar libros:', error);
        contenedor.innerHTML = '<p style="color: red;">No se pudieron cargar los libros.</p>';
      }
    });

    function prepararComentarios(libroDiv, libroId, usuarioId) {
      const form = libroDiv.querySelector('.form-comentario');
      const textarea = form.querySelector('textarea');
      const lista = libroDiv.querySelector('.lista-comentarios');
      const sinComentarios = libroDiv.querySelector('.sin-comentarios');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const contenido = textarea.value.trim();
        if (!contenido) return;

        try {
          const res = await fetch('http://localhost:3000/api/comentarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: usuarioId, libro_id: libroId, contenido })
          });

          if (!res.ok) throw new Error('Error al guardar comentario');

          const nuevoComentario = await res.json();
          mostrarComentario(nuevoComentario, lista);
          textarea.value = '';
          sinComentarios.style.display = 'none';
        } catch (error) {
          console.error('Error al enviar comentario:', error);
          alert('No se pudo enviar el comentario. Intenta más tarde.');
        }
      });

      cargarComentarios(libroId, lista, sinComentarios);
    }

    async function cargarComentarios(libroId, lista, sinComentarios) {
      try {
        const res = await fetch(`http://localhost:3000/api/comentarios/libro/${libroId}`);
        if (!res.ok) throw new Error('Error al cargar comentarios');

        const comentarios = await res.json();
        if (comentarios.length > 0) {
          sinComentarios.style.display = 'none';
          comentarios.forEach(c => mostrarComentario(c, lista));
        }
      } catch (error) {
        console.error('Error al cargar comentarios:', error);
        lista.innerHTML = '<p style="color: red;">No se pudieron cargar los comentarios.</p>';
      }
    }

    function mostrarComentario(comentario, contenedor) {
      const div = document.createElement('div');
      div.className = 'comentario';
      div.innerHTML = `
        <p><strong>${comentario.nombre || 'Anónimo'}:</strong> ${comentario.contenido}</p>
        <small>🕒 ${comentario.fecha}</small>
      `;
      contenedor.appendChild(div);
    }
  </script>
</body>
</html>
